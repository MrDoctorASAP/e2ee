

ChatController

createPersonalChat()
createGroupChat()
deleteGroupChat()
addMemberToGroupChat()
deleteMemberFromGroupChat()

```

user1 -> /createSecure { publicKey } -> server
user1 <- { chatId } <- server

user2 -> /acceptSecure -> server
user2 <- { chatId, publicKey } <- server

user2 -> /push { key, chatId } -> server

user1 -> /poll { chatId } -> server
user1 <- { chatId, key } <- server


user1 -> /commit { chatId } -> server


```

SELECT * FROM CHAT LEFT JOIN CHAT_MEMBER 
    ON CHAT.ID = CHAT_MEMBER.CHAT_ID
    JOIN GROUP_CHAT_INFO
        ON CHAT.ID = GROUP_CHAT_INFO.CHAT_ID
    JOIN MESSAGE 
        ON CHAT.ID = MESSAGE.CHAT_ID
    WHERE CHAT_MEMBER.USER_ID = 2

SELECT * FROM MESSAGE
    LEFT JOIN CHAT_MEMBER ON CHAT_MEMBER.USER_ID = MESSAGE.USER_ID AND CHAT_MEMBER.CHAT_ID = MESSAGE.CHAT_ID
    LEFT JOIN CHAT ON CHAT.ID = MESSAGE.CHAT_ID




// get all last messages
SELECT MESSAGE.* FROM (
    SELECT MAX(MESSAGE.ID) AS MAX FROM MESSAGE 
    LEFT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = MESSAGE.CHAT_ID WHERE CHAT_MEMBER.USER_ID = 2
    GROUP BY MESSAGE.CHAT_ID
) as M 
    LEFT JOIN MESSAGE ON MESSAGE.ID = M.MAX




SELECT * FROM (
    SELECT MAX(MESSAGE.ID) AS MAX FROM MESSAGE 
    LEFT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = MESSAGE.CHAT_ID WHERE CHAT_MEMBER.USER_ID = 2
    GROUP BY MESSAGE.CHAT_ID
) as M 
    LEFT JOIN MESSAGE ON MESSAGE.ID = M.MAX
    RIGHT JOIN CHAT ON MESSAGE.CHAT_ID = CHAT.ID
    LEFT JOIN GROUP_CHAT_INFO ON CHAT.ID = GROUP_CHAT_INFO.CHAT_ID
    LEFT JOIN USER_DETAILS ON MESSAGE.USER_ID = USER_DETAILS.ID
    LEFT JOIN USER_PROFILE ON MESSAGE.USER_ID = USER_PROFILE.USER_ID


SELECT * FROM (
    SELECT MAX(MESSAGE.ID) AS MAX FROM MESSAGE 
    LEFT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = MESSAGE.CHAT_ID WHERE CHAT_MEMBER.USER_ID = 2
    GROUP BY MESSAGE.CHAT_ID
) as M 
    LEFT JOIN MESSAGE ON MESSAGE.ID = M.MAX
    RIGHT JOIN CHAT ON MESSAGE.CHAT_ID = CHAT.ID
    RIGHT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = CHAT.ID
    LEFT JOIN GROUP_CHAT_INFO ON CHAT.ID = GROUP_CHAT_INFO.CHAT_ID
    LEFT JOIN USER_DETAILS ON MESSAGE.USER_ID = USER_DETAILS.ID
    LEFT JOIN USER_PROFILE ON MESSAGE.USER_ID = USER_PROFILE.USER_ID 
    WHERE CHAT_MEMBER.USER_ID = 2

SELECT CHAT_ID, COUNT(*) AS U FROM (SELECT * FROM UNSEEN_MESSAGE WHERE USER_ID = 1)
    GROUP BY CHAT_ID




SELECT * FROM (
    SELECT MAX(MESSAGE.ID) AS MAX FROM MESSAGE 
    LEFT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = MESSAGE.CHAT_ID WHERE CHAT_MEMBER.USER_ID = 2
    GROUP BY MESSAGE.CHAT_ID
) as M 
    LEFT JOIN MESSAGE ON MESSAGE.ID = M.MAX
    RIGHT JOIN CHAT ON MESSAGE.CHAT_ID = CHAT.ID
    RIGHT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = CHAT.ID
    LEFT JOIN GROUP_CHAT_INFO ON CHAT.ID = GROUP_CHAT_INFO.CHAT_ID
    LEFT JOIN USER_DETAILS ON MESSAGE.USER_ID = USER_DETAILS.ID
    LEFT JOIN USER_PROFILE ON MESSAGE.USER_ID = USER_PROFILE.USER_ID
    LEFT JOIN (SELECT CHAT_ID AS UNSEEN_CHAT_ID, COUNT(*) AS UNSEEN FROM (SELECT * FROM UNSEEN_MESSAGE WHERE USER_ID = 1)
    GROUP BY CHAT_ID) ON UNSEEN_CHAT_ID = CHAT.ID
    WHERE CHAT_MEMBER.USER_ID = 2







SELECT * FROM (
    SELECT MAX(MESSAGE.ID) AS MAX FROM MESSAGE 
    LEFT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = MESSAGE.CHAT_ID WHERE CHAT_MEMBER.USER_ID = 2
    GROUP BY MESSAGE.CHAT_ID
) as M 
    LEFT JOIN MESSAGE ON MESSAGE.ID = M.MAX
    RIGHT JOIN CHAT ON MESSAGE.CHAT_ID = CHAT.ID
    RIGHT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = CHAT.ID
    LEFT JOIN GROUP_CHAT_INFO ON CHAT.ID = GROUP_CHAT_INFO.CHAT_ID
    LEFT JOIN USER_DETAILS ON MESSAGE.USER_ID = USER_DETAILS.ID
    LEFT JOIN USER_PROFILE ON MESSAGE.USER_ID = USER_PROFILE.USER_ID
    LEFT JOIN (SELECT CHAT_ID AS UNSEEN_CHAT_ID, COUNT(*) AS UNSEEN FROM UNSEEN_MESSAGE WHERE USER_ID = 2 GROUP BY CHAT_ID) ON UNSEEN_CHAT_ID = CHAT.ID
    LEFT JOIN CHAT_MEMBER AS CM ON CM.CHAT_ID = CHAT.ID AND CHAT.PERSONAL AND CM.USER_ID != 2
    LEFT JOIN USER_DETAILS AS UD ON CM.USER_ID = UD.ID
    LEFT JOIN USER_PROFILE AS UP ON CM.USER_ID = UP.USER_ID
    WHERE CHAT_MEMBER.USER_ID = 2


// TODO: Change FIRST_NAME to LAST_NAME (2 places)
SELECT 
    CHAT.ID AS CHAT_ID, 
    CHAT.PERSONAL, 
    CASEWHEN(UNSEEN IS NULL, 0, UNSEEN) AS UNSEEN,
    USER_DETAILS.ID AS SENDER_ID,
    USER_DETAILS.USERNAME AS SENDER_USERNAME, 
    USER_PROFILE.FIRST_NAME AS SENDER_FIRST_NAME,
    USER_PROFILE.FIRST_NAME AS SENDER_LAST_NAME,
    UD.ID AS PERSONAL_ID,
    UD.USERNAME AS PERSONAL_USERNAME,
    UP.FIRST_NAME AS PERSONAL_FIRST_NAME,
    UP.FIRST_NAME AS PERSONAL_LAST_NAME,
    GROUP_CHAT_INFO.NAME AS GROUP_NAME,
    MESSAGE.ID AS MESSAGE_ID,
    MESSAGE.DATE AS MESSAGE_DATE,
    MESSAGE.MESSAGE AS MESSAGE_TEXT,
FROM (
    SELECT MAX(MESSAGE.ID) AS MAX FROM MESSAGE 
        LEFT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = MESSAGE.CHAT_ID WHERE CHAT_MEMBER.USER_ID = 2
            GROUP BY MESSAGE.CHAT_ID ) as M 
    LEFT JOIN MESSAGE ON MESSAGE.ID = M.MAX
    RIGHT JOIN CHAT ON MESSAGE.CHAT_ID = CHAT.ID
    RIGHT JOIN CHAT_MEMBER ON CHAT_MEMBER.CHAT_ID = CHAT.ID
    LEFT JOIN GROUP_CHAT_INFO ON CHAT.ID = GROUP_CHAT_INFO.CHAT_ID
    LEFT JOIN USER_DETAILS ON MESSAGE.USER_ID = USER_DETAILS.ID
    LEFT JOIN USER_PROFILE ON MESSAGE.USER_ID = USER_PROFILE.USER_ID
    LEFT JOIN (SELECT CHAT_ID AS UNSEEN_CHAT_ID, COUNT(*) AS UNSEEN FROM UNSEEN_MESSAGE WHERE USER_ID = 2 GROUP BY CHAT_ID) 
        ON UNSEEN_CHAT_ID = CHAT.ID
    LEFT JOIN CHAT_MEMBER AS CM ON CM.CHAT_ID = CHAT.ID AND CHAT.PERSONAL AND CM.USER_ID != 2
    LEFT JOIN USER_DETAILS AS UD ON CM.USER_ID = UD.ID
    LEFT JOIN USER_PROFILE AS UP ON CM.USER_ID = UP.USER_ID
    WHERE CHAT_MEMBER.USER_ID = 2


